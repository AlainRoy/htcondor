#!/bin/sh
############# build_openssl-0.9.8l

# Somewhere between 0.9.8h and 0.9.8l, openssl removed -fno-common from
# the compile flags for OS X. On OS X 10.4, this causes the Globus build
# to fail with this error:
#   ld: common symbols not allowed with MH_DYLIB output format with the -multi_module option
#   /scratch/externals/install/openssl-0.9.8l/lib/libcrypto.a(set_key.o) definition of common __shadow_DES_check_key (size 16)
if [ `uname` = "Darwin" ] ; then
  uname -v | grep -q 'Version 8'
  if [ $? -eq 0 ] ; then
      patch -p0 -i osx104.patch
  fi
fi

cd $PACKAGE_SRC_NAME

# Omitting the frame pointer makes debugging very difficult.
# A quick test on a modern x86 linux machine showed a roughly 4%
# slowdown when the frame pointer is left in place.
sed 's/-fomit-frame-pointer//' Configure > Configure.new
mv Configure.new Configure

# Globus builds on some platforms fail in creating their shared libraies
# if OpenSSL isn't built with -fPIC
if [ `uname` = "AIX" ] ; then
    ./config --prefix=$PACKAGE_INSTALL_DIR --with-krb5-dir=$KERBEROS_DIR no-asm
else
    ./config --prefix=$PACKAGE_INSTALL_DIR --with-krb5-dir=$KERBEROS_DIR no-asm -fPIC
fi
if [ $? -ne 0 ]
then
    echo "config failed"
    exit 1
fi

make
if [ $? -ne 0 ]
then
    echo "make failed"
    exit 1
fi

make test
if [ $? -ne 0 ]
then
    echo "test failed"
    exit 2
fi

mkdir -p $PACKAGE_INSTALL_DIR
make install
if [ $? -ne 0 ]
then
    echo "install failed"
    exit 3
fi

exit 0

############# end of build_openssl-0.9.8l
