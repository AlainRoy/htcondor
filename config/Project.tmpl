/************************************************************************** 
** There shouldn't be any platform-specific info in this.  By now, all
** the platform, version and OS specific files have been included.
**************************************************************************/

LIBC = LibC
SIMPLE_LIBC = SimpleLibC
EGCS_LIBC = LIB_GCC

CRT0 = Crt0

TOP = Top
TMP_DIR = TmpDir
PLATFORM = Platform

PLATFORM_DIR	=	$(TOP)/$(PLATFORM)
RELEASE_DIR	=	../release_dir
STRIP_DIR	=	../strip_dir
STRIP_CONTRIB	=	../strip_contrib
STATIC_DIR	=	../static_dir
STATIC_CONTRIB	=	../static_contrib
PURE_DIR	=	pure_bin

LIB_DIR =		$(RELEASE_DIR)/lib
CONFIG_DIR =		$(TOP)/config
SRC_TREE =		$(TOP)/src
DOC_TREE =		$(TOP)/doc
INCLUDE_DIR =		../h
NEW_INCLUDE_DIR =	../condor_includes
C_PLUS_INCLUDE =	../condor_c++_util

#ifdef X11Include
X11_INCLUDE = X11Include
#else
X11_INCLUDE = /usr/X11R6/include	
#endif

#if !defined( CLinker )
#define CLinker CCompiler
#endif

#if !defined( CPlusLinker )
#define CPlusLinker CPlusCompiler
#endif

#if !defined(PlatformGccFlags)
#define PlatformGccFlags
#endif

#if !defined(PlatformLdFlags)
#define PlatformLdFlags
#endif

#if !defined(TestPlatformLdFlags)
#define TestPlatformLdFlags
#endif

#if !defined(Strip)
#define Strip strip
#endif

/*
   These next few lines are not supposed to be pre-processor
   directives, but GNU-make understood directives.  They don't want a
   # in front of them.  If you're having problems at these lines,
   you're probably not using gmake.  -peter keller 9/8/2000
*/
ifdef DEBUG_BUILD
CC =  $(DEBUG_BUILD) CCompiler
CPlusPlus = $(DEBUG_BUILD) CPlusCompiler
C_LINK = $(DEBUG_BUILD) CLinker
CC_LINK = $(DEBUG_BUILD) CPlusLinker
else
CC = CCompiler
CPlusPlus = CPlusCompiler
C_LINK = CLinker
CC_LINK = CPlusLinker
endif

LIBX = XLibPath
LIBXEXT = XExtLibPath
STRIP = Strip
STATIC	= StaticFlag
MKDEPEND = MkDepend
STAR	= *

PLATFORM_LDFLAGS = PlatformLdFlags
TEST_PLATFORM_LDFLAGS = TestPlatformLdFlags

/*
   These next few lines are not supposed to be pre-processor
   directives, but GNU-make understood directives.  They don't want a
   # in front of them.  If you're having problems at these lines,
   you're probably not using gmake.  -Derek Wright 6/16/99
*/
ifdef SMP_NUM_JOBS
SMP_FLAGS = -j $(SMP_NUM_JOBS)
else
SMP_FLAGS =
endif

#define UNIX_RT0	$(CRT0)
#define UNIX_LIBC	$(LIBC)
#define CKPT_RT0	$(RELEASE_DIR)/lib/condor_rt0.o
#define CONDOR_RT0	$(RELEASE_DIR)/lib/condor_rt0.o
#define CKPT_LIBC	$(RELEASE_DIR)/lib/libckpt.a
#define CONDOR_LIBC	$(RELEASE_DIR)/lib/libcondor.a

#define AR_DELETE(libname,objects) ar d libname objects
#define AR_EXTRACT(libname,objects) ar x libname objects

#if HAS_AR_S_OPTION
#define AR_REPLACE(libname,objects) ar vrs libname objects
#else
#define AR_REPLACE(libname,objects) \
	ar vr libname objects @@\
	ranlib libname
#endif


#if HAS_CP_PRESERVE			/* cp lib w/o changing modify time - don't ranlib */
#	define COPY_LIBRARY(src,dst) cp -p src dst
#	define RANLIB_TOUCH(lib)	/**/
#else
#	if HAS_RANLIB_TOUCH		/* cp lib changes modify time - ranlib -t */
#		define COPY_LIBRARY(src,dst) cp src dst
#		define RANLIB_TOUCH(libname) ranlib -t libname
#	else						/* dumb cp and ranlib - do it the hard way */
#		define COPY_LIBRARY(src,dst) cp src dst
#		define RANLIB_TOUCH(libname) ranlib libname
#	endif
#endif

#ifndef IS_CLIPPED
#  define IS_CLIPPED NO
#endif
#if IS_CLIPPED
#  undef DOES_CHECKPOINTING
#  define DOES_CHECKPOINTING NO
#  undef DOES_COMPRESS_CKPT
#  define DOES_COMPRESS_CKPT NO
#  undef DOES_REMOTE_SYSCALLS
#  define DOES_REMOTE_SYSCALLS NO
#endif /* IS_CLIPPED */

#ifdef XIncludeFlag
#define XInclude XIncludeFlag
#else
#define XInclude
#endif

#ifndef FORTRAN_HAS_RECURSION
#define FORTRAN_HAS_RECURSION NO
#endif

#ifndef HAS_INET_NTOA
#define HAS_INET_NTOA YES
#endif

#ifndef NEEDS_SPECIAL_STATIC_BUILD
#define NEEDS_SPECIAL_STATIC_BUILD NO
#endif

OS_FLAG = OperatingSystem
ARCH_FLAG = Architecture

#if !defined( DebugFlag )
#define DebugFlag -g
#endif

DEBUG_FLAG = DebugFlag

#if !defined( IS_EGCS_BUILD )
#define IS_EGCS_BUILD NO
#endif

#if !defined( YACC )
#define YACC yacc
#endif

#if !defined( PlatformFlags ) 
#define PlatformFlags
#endif

#if !defined( VendorCTestFlags )
#define VendorCTestFlags
#endif

#if !defined( VendorCPPTestFlags )
#define VendorCPPTestFlags
#endif

#if !defined( VendorFTestFlags )
#define VendorFTestFlags
#endif

GLOBUS_DIR = /unsup/globus-2.0-beta

#if WANT_GLOBUS && HAS_GLOBUS

# define GLOBUS_SUPPORT 1

  /* GLOBUS_SUPPORT includes GSS_AUTHENTICATION as well */
# undef GSS_AUTHENTICATION
# define GSS_AUTHENTICATION 1

#if HAS_LDAP

  LDAP_DIR = $(GLOBUS_DIR)
  SASL_DIR = /local.perdita/hbwang
  LDAP_LIB = $(SASL_DIR)/lib/libsasl2.a \
             $(LDAP_DIR)/lib/libldap.a \
             $(LDAP_DIR)/lib/liblber.a
  LDAP_FLAGS = -DLDAP_DEBUG -DLDAP_REFERRALS -I$(LDAP_DIR)/include/gcc32dbg
#else
  LDAP_FLAGS = 
  LDAP_LIB   = 
#endif

  GLOBUS_FLAGS = -DGLOBUS_SUPPORT -I$(GLOBUS_DIR)/include/gcc32dbg \
                 $(LDAP_FLAGS)

  GLOBUS_LIB = $(GLOBUS_DIR)/lib/libglobus_rsl_assist_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_duct_common_gcc32dbg.a   \
    $(GLOBUS_DIR)/lib/libglobus_duct_control_gcc32dbg.a   \
    $(GLOBUS_DIR)/lib/libglobus_gram_protocol_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_duroc_common_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_duroc_control_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_rsl_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_nexus_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_mp_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_dc_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_gram_client_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_gass_server_ez_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_gass_transfer_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_ftp_client_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_ftp_control_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_io_gcc32dbg.a \
    $(GLOBUS_DIR)/lib/libglobus_common_gcc32dbg.a \
    $(LDAP_LIB)

# define IsCondorG -DCONDOR_G
#else
# define IsCondorG 
#endif /*HasGlobus && WantsGlobus */

/* X509 Authentication requires globus*/
#if WANT_X509 && HAS_GLOBUS

  X509_FLAGS = -DGSS_AUTHENTICATION -DNO_GSSAPI_CONFIG_H \
                   -I$(GLOBUS_DIR)/include -I$(OpenSSLIncludePath)

  X509_LIB = $(GLOBUS_DIR)/lib/libglobus_gss_assist_gcc32dbg.a \
             $(GLOBUS_DIR)/lib/libglobus_gssapi_gsi_gcc32dbg.a \
             $(GLOBUS_DIR)/lib/libglobus_ssl_utils_gcc32dbg.a  \
             $(OpenSSL_LIB)
             /* OPENSSL_LIB is defined in site.def */
#else

  X509_FLAGS =
  X509_LIB   = 

#endif /* !defined( WANT_X509 && HAS_GLOBUS ) */

/* Kerberos */
#if HAS_KERBEROS && WANT_KERBEROS
  KERBEROS_FLAG = -DKERBEROS_AUTHENTICATION -I$(KERBEROS_INCLUDE)
#else
  KERBEROS_FLAG = 
#endif /* !defined(WANT_KERBEROS) */

/* Encryption */
#if CONDOR_3DES_ENCRYPTION
    CONDOR_3DES_FLAGS = -DCONDOR_3DES_ENCRYPTION
    #define NEED_OPENSSL YES
    #define CONDOR_ENCRYPTION YES
#else 
    CONDOR_3DES_FLAGS =
#endif

#if CONDOR_BLOWFISH_ENCRYPTION
    CONDOR_BLOWFISH_FLAGS = -DCONDOR_BLOWFISH_ENCRYPTION
    #define NEED_OPENSSL YES
    #define CONDOR_ENCRYPTION YES
#else
    CONDOR_BLOWFISH_FLAGS =
#endif

#if CONDOR_ENCRYPTION
ENCRYPTION_FLAGS = -DCONDOR_ENCRYPTION $(CONDOR_3DES_FLAGS) $(CONDOR_BLOWFISH_FLAGS) -I$(OpenSSLIncludePath)
#endif

#if NEED_OPENSSL
  ENCRYPTION_LIB = $(OpenSSL_LIB)
#else
  ENCRYPTION_LIB =
#endif

#if WANT_MD
    MD_LIB = $(OpenSSL_LIB)
    MD_FLAGS = -DCONDOR_MD -I$(OpenSSLIncludePath)
#else
    MD_LIB =
    MD_FLAGS = 
#endif

#if WANT_NETMAN
NETMAN_LIB = ../condor_netman/libnetman.a
NETMAN_FLAGS = -DWANT_NETMAN
#else
NETMAN_LIB =
NETMAN_FLAGS =
#endif

VENDOR_C_FLAGS = CFlags -I$(INCLUDE_DIR) -I$(NEW_INCLUDE_DIR) \
		 -I$(C_PLUS_INCLUDE) XInclude -D$(ARCH_FLAG)=$(ARCH_FLAG) \
		 -D$(OS_FLAG)=$(OS_FLAG) $(KERBEROS_FLAG) $(ENCRYPTION_FLAGS) \
		 $(SITE_C_FLAGS) $(X509_FLAGS) $(GLOBUS_FLAGS) $(NETMAN_FLAGS) \
                 $(MD_FLAGS)

/*
Generally, compile with -fPIC for position-independent code.
However, leave it as a separate Make variable so that particular
modules that cannot use it (i.e. checkpointing) can turn it off.

This is commented out by default.
This will only be activated for special builds done by hand to
make the SDK.
*/

/* CC_PIC_FLAG = -fPIC */

STD_C_FLAGS = $(VENDOR_C_FLAGS) $(DEBUG_FLAG) $(CC_PIC_FLAG) PlatformFlags PlatformGccFlags
STD_C_PLUS_FLAGS = $(STD_C_FLAGS) -fno-implicit-templates
INST_C_PLUS_FLAGS = $(STD_C_FLAGS)

TESTSUITE_FLAGS_GCC =  $(STD_C_FLAGS)
TESTSUITE_FLAGS_GPP = $(STD_C_PLUS_FLAGS)
TESTSUITE_FLAGS_G77 =  $(STD_C_FLAGS)
TESTSUITE_FLAGS_CC = -g $(VENDOR_C_FLAGS) VendorCTestFlags PlatformFlags
TESTSUITE_FLAGS_CPP = -g $(VENDOR_C_FLAGS) VendorCPPTestFlags PlatformFlags
TESTSUITE_FLAGS_F77 = -g $(VENDOR_C_FLAGS) VendorFTestFlags PlatformFlags


CKPT_SERV_LIB = ../condor_ckpt_server/ckpt_server_api.a
QMGMT_LIB = ../condor_schedd.V6/libqmgmt.a
CLASSAD_LIB = ../condor_classad/libclassad.a
IO_LIB = ../condor_io/libcedar.a
CUTIL_LIB = ../condor_util_lib/util_lib.a
CPLUS_LIB = ../condor_c++_util/cplus_lib.a
PROCAPI_LIB = ../condor_procapi/libprocapi.a
SYSAPI_LIB = ../condor_sysapi/libsysapi.a
ACCT_LIB    = ../condor_accountant.V6/libacct.a
DAEMONCORE_LIB = ../condor_daemon_core.V6/daemon_core.a

ALL_LDFLAGS = -lm $(LDFLAGS) $(PLATFORM_LDFLAGS) $(SITE_LDFLAGS)
TEST_LDFLAGS = -lm $(LDFLAGS) $(TEST_PLATFORM_LDFLAGS) $(SITE_LDFLAGS)

/* Credential API related libraries */
CONDOR_CRED_LIB = 

STD_LIBS = \
  $(CUTIL_LIB) \
  $(CPLUS_LIB) \
  $(CKPT_SERV_LIB) \
  $(QMGMT_LIB) \
  $(ACCT_LIB) \
  $(PROCAPI_LIB) \
  $(SYSAPI_LIB) \
  $(CPLUS_LIB) \
  $(CLASSAD_LIB) \
  $(IO_LIB) \
  $(CPLUS_LIB) \
  $(CUTIL_LIB) \
  $(GLOBUS_LIB) \
  $(SYSAPI_LIB) \
  $(CPLUS_LIB) \
  $(CUTIL_LIB) \
  $(SYSAPI_LIB) \
  $(CLASSAD_LIB) \
  $(IO_LIB) \
  $(CPLUS_LIB) \
  $(IO_LIB) \
  $(CPLUS_LIB) \
  $(CUTIL_LIB) \
  $(CREDENTIAL_LIB) \
  $(X509_LIB) \
  $(KERBEROS_LIB) \
  $(ENCRYPTION_LIB) \
  $(MD_LIB)

