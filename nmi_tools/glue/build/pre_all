#!/usr/bin/env perl
##**************************************************************
##
## Copyright (C) 1990-2010, Condor Team, Computer Sciences Department,
## University of Wisconsin-Madison, WI.
## 
## Licensed under the Apache License, Version 2.0 (the "License"); you
## may not use this file except in compliance with the License.  You may
## obtain a copy of the License at
## 
##    http://www.apache.org/licenses/LICENSE-2.0
## 
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.
##
##**************************************************************

######################################################################
# $Id: pre_all,
#
######################################################################

######################################################################
# NOTE: This script depends on the following bootstrap programs:
# - GNU tar (so long as it supports --exclude)
# - GNU autoconf and autoheader (version >= 2.59) [used by build_init]
# - everything required for "make nroff"
#    - latex
#    - latex2html
#    ...  ;) (could fill this in later)
######################################################################

use Cwd;

use Getopt::Long;
use vars qw/ $opt_skip_doc/;
GetOptions(
  'skip-doc' => \$opt_skip_doc,
);

# autoflush our STDOUT
$| = 1;

my $CommonDir = getcwd();
my $SrcDir = "$CommonDir/src";
my $DocDir = "$CommonDir/doc";

-d $CommonDir || die "$CommonDir does not exist!\n";
-d $SrcDir || die "$SrcDir does not exist!\n";

######################################################################
# Step #1: build nroff sources
######################################################################

if(!(defined $opt_skip_doc)){
	print "Building man page nroff source\n";
	chdir( "$DocDir" ) || die "Can't chdir($DocDir): $!\n";
	my $doc_log = "$CommonDir/nroff.log";
	open( DOC, "make just-man-pages 2>&1|" ) || die "Can't open 'make just-man-pages': $!\n";
	open( DOC_LOG, ">$doc_log" ) || die "Can't open $doc_log: $!\n";
	$oldfh = select(DOC_LOG); $| = 1; select($oldfh);
	while( <DOC> ) {
    	print DOC_LOG "$_";
	}
	close( DOC );
	close( DOC_LOG );
	$nroff_status = $?;
	if( $nroff_status ) {
		print `cat $doc_log`;
    	die "Building nroff man pages failed with status $nroff_status!\n";
	} else {
    	unlink( $doc_log ) || warn "Can't unlink($doc_log): $!\n";
	}
	print "Building nroff man pages successful, tar'ing up results\n";
	-d "$ExtDir/bundles/man/current" || 
   		die "$ExtDir/bundles/man/current doesn't exist! Build tag broken\n";
	system("tar zcf $ExtDir/bundles/man/current/man-current.tar.gz man");
	print "Finished packaging man page nroff source\n";

	chdir( "$CommonDir" ) || die "Can't chdir($CommonDir): $!\n";
	print "Removing doc directory\n";
	system( "rm -rf $DocDir" );
	print "Done removing doc directory\n";
} else {
	print "Doc being skipped as requested\n";
}
